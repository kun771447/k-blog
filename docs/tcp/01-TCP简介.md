---
title: TCP 简介
isTop: true
date: 2023/02/10
tags:
 - TCP
---

# TCP 简介

## TCP 历史及其设计哲学

TCP/IP 的前身是美国国防部的 APRA 网中的 NCP 协议

NCP 协议没有遵循 OSI 七层模型，网络层和传输层都融在 NCP 这一个协议

- 存在问题
  - 一是这个网络中只有一台主机对另一台主机通讯，没有 IP地址这个概念
  - 二是这个网络中没有容错功能，这个网络扩大的时候错误明显提高，网络效率低下

### 1973 TCP/IP 协议

<img src="\tcp\01\2023-02-11-08-57-19-image.png" />

### TCP/IP 协议发展

<img src="\tcp\01\2023-02-11-08-59-30-image.png" />

- 1973 年提出 TCP v1, 这是还没有 IP 协议，IP 协议的功能都包含在 TCP 中

- 1978 年 **Jon Postel** 提出了 TCP 协议，没有按照 OSI 进行分层

- 1980 年 TCP 就被分层，分为 TCP v4 和 IPV4，这也就是为什么没有 IP v1 2 3 的原因

### TCPv4 协议分层后的互联网世界

<img src="\tcp\01\2023-02-11-09-08-28-image.png" />

- IP 协议，专注解决如 何在网络中传递消息

- TCP 协议 解决了任意长度消息的传输，而且可以保证是可靠的传输，让应用层可以不用考虑这些问题

### TCP/IP 的七个设计理念

<img src="\tcp\01\2023-02-11-09-14-59-image.png" />

1.  APRA 网最大的问题容错率很低，所以 TCP/IP 的设计理念要能够容错，所以我们 TCP x协议中会有基于滑动窗口的容错机制

2.  APRA 网是军工网络，军工网络相对是不开王，要求 TCP/IP 协议必须支持不同类型的网络设备，斯克，华为各种不同的路由器和交换机

3. 当初想把 APRA 网与其网络进行连接遇到了问题，所以 TCP/IP 的设计理念能够连接各种不同种类的网络，WIFI，海底光纤，光缆

## TCP 解决了那些问题

### TCP 的作用

<img src="\tcp\01\2023-02-11-09-30-12-image.png" />

这幅图中存在三个网络，客户端网络，广域网，服务端网络


客户端网络发起了网络请求先由这条蓝色的线，先由数据链路层发送到路由器上，根据我们网络层也就是 IP 层选择最短的路径，TCP 则是把我们这个不定长度 HTTP 请求，切分成 TCP 认为合适的段，在中间任意一个结点中这个报文可能会被丢掉，路径也有可能发生变化，TCP 必须保证每一个段必须到达 HTTP Server，TCP 都是由操作系统的内核实现的，将 HTTP Request 相同的顺序交给 Tomact 登服务器，Tomact 处理完生成 web 页面, 通过相同的路径返回


在这样的网络中如何选入跨越不同的网络是由我们的 IP 和数据链路层决定的，如何构造消息和响应是由应用层决定的，数据如何可靠的发出，如何保证顺序是由 TCP 协议决定的



### TCP 协议的分层

- TCP: 面向连接的、可靠的、基于字节流的传输层通信协议
  
  - 面向连接：一对一的
  
  - 可靠的：网络链路中出现了怎样的链路变化，TCP 协议都可以保证一个报文一定能够最终到达接收端
  
  - 基于字节流：消息是没有边界的，保证有序的，即使先接受到后面的字节，也不能扔给应用层去处理

- IP: 根据 IP 地址穿越网络传输数据

<img src="\tcp\01\2023-02-11-10-36-03-image.png" />

### 层层签到的”信封“：报文头部

<img src="\tcp\01\2023-02-11-10-43-09-image.png" />

### 报文头部的层层组装与卸载

- 不可靠的网络传输
  
  - 网络设备
  
  - 主机
  
  - 物理链路

<img src="\tcp\01\2023-02-11-10-45-46-image.png" />

### TCP 协议特点

- **在IP协议之上，解决网络通讯可依赖问题**
  
  - 点对点(不能广播、多播)，面向连接
  
  - 双向传递(全双工) 
  
  - 字节流：打包成报文段、保证有序接收、重复报文自动丢弃
    
    - 缺点：不维护应用报文的边界(对比HTTP HTTP报文必须自己去做 /r/n 结尾、 GRPC)
    
    - 优点：不强制要求应用必须离散的创建数据块，不限制数据块大
  
  - 流量缓冲：解决速度不匹配问题
    
    - 客户端和服务器设备可能不一样，处理速度不匹配
  
  - 可靠的传输服务(保证可达，丢包时通过重发进而增加时延实现可靠性)
  
  - 拥塞控制



## TCP 报文格式

### 消息传输的核心要素

<img src="\tcp\01\2023-02-11-11-04-29-image.png" />

- 寄件人与收件人信息
  
  - IP 地址
  
  - TCP(UDP) 端口
  
  - HTTP Host/URI 等

- 物流订单号
  
  - IP 序列号
  
  - TCP 序列号

- 物流系统需求

### IP 头部

<img src="\tcp\01\2023-02-11-11-21-39-image.png" />

- Source Address：源地址

- Destination Address：目标地址

- Identification：IP序列号(物流订单号)

- TTL:  IP 数据包在计算机网络中可以转发的最大跳数
  
  - TTL减少为0，路由器将会丢弃收到的TTL=0的IP包并向IP包的发送者发送 ICMP time exceeded消息。

### UDP 头部

<img src="\tcp\01\2023-02-11-11-28-56-image.png" />

- Source Port：源端口

- Destination Port：目标端口

- Checksum：容错的效验码

### TCP 协议的任务

- 主机内的进程寻址

- 创建、管理、终止连接

- 处理并将 **字节(8bit)** 流打包成报文段(如IP报文)

- 传输数据

- 保持可靠性与传输质量

- 流控制与拥塞控制

### 如何标识一个连接

- **TCP 四元组(源地址，源端口，目的地址，目的端口)**
  
  - 对于 IPv4 地址，单主机最大 TCP 连接数为 2^(32 + 16 + 32 + 16)

- 没有连接 ID：QUIC 协议

<img src="\tcp\01\2023-02-11-11-37-36-image.png" />

### TCP Segment 报文段

- 控制信息
  
  - 寻址
  
  - 滑动窗口
  
  - Flags
  
  - 校验和

- 数据

<img src="\tcp\01\2023-02-11-11-43-05-image.png" />

- Sequence Number

- Acknowledgment Number

描述我们的订单号，用来唯一表示 HTTP 报文的，ack 还用来确认报文，来保证数据的可达性

### 常用选项

<img src="\tcp\01\2023-02-11-11-48-05-image.png" />

## 如何使用 tcpdump

### 捕获及停止条件

- -D列举所有网卡设备

- -i选择网卡设备

- -C抓取多少条报文

- --time-stamp-precision 指定捕获时的时间精度，默认毫秒 micro, 可选纳秒 nano

- -S 指定每条报文的最大字节数，默认 262144 字节

```shell
tcpdump -D
```



抓取 2 条网络报文，并设置时间精度

```js
tcpdump -i 网卡设备 -c 2 --time-stamp-precision nano
```
